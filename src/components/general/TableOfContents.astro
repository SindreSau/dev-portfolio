---
import { cn } from "@/utils/cn";

export interface Props {
    sections: { id: string; title: string }[];
}

const { sections } = Astro.props;
const tocTitle = "Table of Contents";
---

<div id="toc-container" class="toc-container">
    <nav aria-label="Table of contents">
        <div class="md:hidden relative">
            {/* Mobile alternative: Dropdown */}
            <button
                id="toc-mobile-button"
                type="button"
                class="flex w-full items-center justify-between rounded-md border border-border bg-background-secondary p-2 text-sm font-medium text-text-secondary hover:bg-background-tertiary focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background-secondary"
                aria-expanded="false"
                aria-haspopup="true"
                aria-controls="toc-mobile-menu"
            >
                <span id="toc-mobile-selected-title">{tocTitle}</span>
                <svg
                    class="h-5 w-5"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                    aria-hidden="true"
                >
                    <path
                        fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd"></path>
                </svg>
            </button>
            <ul
                id="toc-mobile-menu"
                class="absolute z-10 mt-1 hidden w-full rounded-md border border-border bg-background-secondary shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                role="menu"
                aria-orientation="vertical"
                aria-labelledby="toc-mobile-button"
            >
                {
                    sections.map(section => (
                        <li role="presentation">
                            <a
                                href={`#${section.id}`}
                                id={`toc-link-mobile-${section.id}`}
                                class={cn(
                                    "block px-4 py-2 text-sm text-text-secondary hover:bg-background-tertiary hover:text-primary",
                                    "toc-link-mobile" // Common class for JS targeting
                                )}
                                role="menuitem"
                                data-section-id={section.id}
                                data-section-title={section.title}
                            >
                                {section.title}
                            </a>
                        </li>
                    ))
                }
            </ul>
        </div>

        {/* Desktop: Sticky Sidebar */}
        <ul class="hidden md:block space-y-2">
            {
                sections.map(section => (
                    <li>
                        <a
                            href={`#${section.id}`}
                            id={`toc-link-${section.id}`}
                            class={cn(
                                "block py-1 text-sm hover:text-primary transition-colors duration-150",
                                "toc-link" // Common class for JS targeting
                            )}
                            data-section-id={section.id}
                        >
                            {section.title}
                        </a>
                    </li>
                ))
            }
        </ul>
    </nav>
</div>

<script define:vars={{ tocTitleFromProps: tocTitle }}>
    document.addEventListener("DOMContentLoaded", () => {
        const desktopLinks =
            document.querySelectorAll<HTMLAnchorElement>(".toc-link");
        const mobileLinks =
            document.querySelectorAll<HTMLAnchorElement>(".toc-link-mobile");
        const sections = document.querySelectorAll<HTMLElement>(".cv-section");
        const tocMobileSelectedTitle = document.getElementById(
            "toc-mobile-selected-title"
        );
        const tocMobileButton = document.getElementById("toc-mobile-button");
        const tocMobileMenu = document.getElementById("toc-mobile-menu");

        const tocTitle = tocTitleFromProps;

        if ((!desktopLinks.length && !mobileLinks.length) || !sections.length) {
            console.warn(
                "TOC links or CV sections not found. Active highlighting might not work."
            );
            return;
        }

        const allLinks = [...desktopLinks, ...mobileLinks];

        const observerOptions = {
            root: null,
            rootMargin: "-20% 0px -70% 0px",
            threshold: 0,
        };

        const observer = new IntersectionObserver(entries => {
            let firstVisibleSectionId;
            let firstVisibleSectionTitle;

            entries.forEach(entry => {
                const id = entry.target.getAttribute("id");
                const correspondingDesktopLink =
                    document.querySelector<HTMLAnchorElement>(
                        `.toc-link[data-section-id="${id}"]`
                    );
                const correspondingMobileLink =
                    document.querySelector<HTMLAnchorElement>(
                        `.toc-link-mobile[data-section-id="${id}"]`
                    );

                if (entry.isIntersecting) {
                    if (!firstVisibleSectionId && id) {
                        firstVisibleSectionId = id;
                        firstVisibleSectionTitle =
                            correspondingMobileLink?.dataset.sectionTitle ||
                            correspondingDesktopLink?.textContent?.trim() ||
                            tocTitle;
                    }
                    desktopLinks.forEach(link =>
                        link.classList.remove("text-primary", "font-semibold")
                    );
                    mobileLinks.forEach(link =>
                        link.classList.remove(
                            "bg-background-darker",
                            "text-primary"
                        )
                    );

                    correspondingDesktopLink?.classList.add(
                        "text-primary",
                        "font-semibold"
                    );
                    correspondingMobileLink?.classList.add(
                        "bg-background-darker",
                        "text-primary"
                    );
                } else {
                    correspondingDesktopLink?.classList.remove(
                        "text-primary",
                        "font-semibold"
                    );
                    correspondingMobileLink?.classList.remove(
                        "bg-background-darker",
                        "text-primary"
                    );
                }
            });

            if (tocMobileSelectedTitle) {
                let activeTitle = tocTitle;
                const activeDesktopLink =
                    document.querySelector<HTMLAnchorElement>(
                        ".toc-link.text-primary"
                    );
                if (activeDesktopLink && activeDesktopLink.textContent) {
                    activeTitle = activeDesktopLink.textContent.trim();
                }
                if (firstVisibleSectionTitle) {
                    activeTitle = firstVisibleSectionTitle;
                }
                tocMobileSelectedTitle.textContent = activeTitle;
            }
        }, observerOptions);

        sections.forEach(section => {
            observer.observe(section);
        });

        allLinks.forEach(link => {
            link.addEventListener("click", function (this, e) {
                e.preventDefault();
                const targetId = this.getAttribute("href")?.substring(1);
                if (targetId) {
                    document.getElementById(targetId)?.scrollIntoView({
                        behavior: "smooth",
                    });
                    if (
                        this.classList.contains("toc-link-mobile") &&
                        tocMobileSelectedTitle
                    ) {
                        tocMobileSelectedTitle.textContent =
                            this.dataset.sectionTitle ||
                            this.textContent?.trim() ||
                            tocTitle;
                        // Hide mobile menu after click
                        if (tocMobileMenu) {
                            tocMobileMenu.classList.add("hidden");
                            tocMobileButton?.setAttribute(
                                "aria-expanded",
                                "false"
                            );
                        }
                    }
                }
            });
        });

        // Mobile TOC dropdown toggle
        if (tocMobileButton && tocMobileMenu) {
            tocMobileButton.addEventListener("click", () => {
                const isExpanded =
                    tocMobileButton.getAttribute("aria-expanded") === "true" ||
                    false;
                tocMobileButton.setAttribute(
                    "aria-expanded",
                    (!isExpanded).toString()
                );
                tocMobileMenu.classList.toggle("hidden");
            });

            // Close dropdown if clicked outside
            document.addEventListener("click", event => {
                if (
                    tocMobileButton &&
                    tocMobileMenu &&
                    !tocMobileButton.contains(event.target) &&
                    !tocMobileMenu.contains(event.target)
                ) {
                    tocMobileMenu.classList.add("hidden");
                    tocMobileButton.setAttribute("aria-expanded", "false");
                }
            });
        }
    });
</script>
